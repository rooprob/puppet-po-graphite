#!/bin/sh
# !!! generated by puppet !!!

### BEGIN INIT INFO
# chkconfig: 2345 99 80
# Provides: carbon-aggregator
# Required-Start: $remote_fs $network $time
# Required-Stop: $remote_fs $network
# Default-Start:  2 3 4 5
# Default-Stop:   0 1 6
# Short-Description: Start/Stop carbon-aggregator
# Description: Enables Graphites carbon-aggregator data aggregation engine
### END INIT INFO

export PATH=/opt/graphite/bin:$PATH
<% scope.lookupvar('graphite::caches').each do | name, cache | 
	cc = 0
	start_collection = ""
	stop_collection = ""
	status_collection = ""
	while cc < cache['count'].to_i
		start_collection = "#{start_collection}\n\t\tpython /opt/graphite/bin/carbon-relay.py --instance=#{cc} start"
		stop_collection = "#{stop_collection}\n\t\tpython /opt/graphite/bin/carbon-relay.py --instance=#{cc} stop"
		status_collection = "#{status_collection}\n\t\tpython /opt/graphite/bin/carbon-relay.py --instance=#{cc} status"
		cc += 1
	end
end %>

case "$1" in
	start)
		python /opt/graphite/bin/carbon-aggregator.py start
		;;
	stop)
		python /opt/graphite/bin/carbon-aggregator.py stop
		;;
	status)
		python /opt/graphite/bin/carbon-aggregator.py status
		;;
	restart)
		$0 stop ; sleep 3 ; $0 start
		RC=$?
		exit $RC
		;;
	*)
		echo "Usage: $0 {start|stop|restart|status}"
		exit 1
		;;
esac

exit
